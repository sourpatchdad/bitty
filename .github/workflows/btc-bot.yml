name: Bitty BTC Bot

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:
    inputs:
      debug_mode:
        description: 'Enable debug mode (sends heartbeat notification)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

concurrency:
  group: bitty-bot
  cancel-in-progress: false

jobs:
  run-bot:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: python -m pip install --upgrade requests

      - name: Ensure state dir
        run: mkdir -p .github/state

      - name: Run bot
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          DEBUG_MODE: ${{ github.event.inputs.debug_mode || 'false' }}
        run: python bot.py

      - name: Commit updated state
        run: |
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          if [ -n "$(git status --porcelain .github/state/btc_state.json)" ]; then
            git add .github/state/btc_state.json
            git commit -m "Update btc_state.json $(date -u +'%Y-%m-%dT%H:%M:%SZ')"
            git push
          fi
